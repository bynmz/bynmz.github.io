<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>

  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Twitter cards -->
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:title" content="Offscreen rendering in Vulkan">

  
  <meta name="twitter:description" content="In the last post we looked at integrating a simple UI with Dear Imgui using my vulkan renderer. Now we shall look at offscreen rendering. This can be used for various purposes such as post-processing effects, rendering to textures for later use, shadow mapping, reflections etc. In this example we shall look at offscreen rendering for reflections. After having a decent understanding of the Vulkan specification and having gone through the renderer sample code provided, you can follow along or use this as a general guide on how you can implement this in your own projects. The intention of this is not to serve as a tutorial for beginners but as a guide for someone with a good enough understanding of the Vulkan specification and some modern C++ knowledge.

">
  
  <meta name="twitter:image" content="https://bynmz.github.io/images/avatar.jpg">
  <!-- end of Twitter cards -->

  <!-- OpenGraph metadata -->
  <meta property="og:title" content="Offscreen rendering in Vulkan">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://bynmz.github.io/2024/03/28/offscreen-rendering-in-vulkan/">

  
  <meta property="og:description" content="In the last post we looked at integrating a simple UI with Dear Imgui using my vulkan renderer. Now we shall look at offscreen rendering. This can be used for various purposes such as post-processing effects, rendering to textures for later use, shadow mapping, reflections etc. In this example we shall look at offscreen rendering for reflections. After having a decent understanding of the Vulkan specification and having gone through the renderer sample code provided, you can follow along or use this as a general guide on how you can implement this in your own projects. The intention of this is not to serve as a tutorial for beginners but as a guide for someone with a good enough understanding of the Vulkan specification and some modern C++ knowledge.

">
  

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    bynmz.io - Offscreen rendering in Vulkan
  </title>

  <!-- Disable favicon -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <!-- CSS -->
  <style type="text/css">
  @font-face {
    font-family: 'PT Sans'; font-style: normal; font-weight: 400;
    font-display: fallback;
    src: local('PT Sans'), local('PTSans-Regular'), url(/fonts/pt_sans-web-regular-webfont.woff) format('woff');
  }
  @font-face {
    font-family: 'PT Sans'; font-style: normal; font-weight: 700;
    font-display: fallback;
    src: local('PT Sans Bold'), local('PTSans-Bold'), url(/fonts/pt_sans-web-bold-webfont.woff) format('woff');
  }
  @font-face {
    font-family: 'PT Sans'; font-style: italic; font-weight: 400;
    font-display: fallback;
    src: local('PT Sans Italic'), local('PTSans-Italic'), url(/fonts/pt_sans-web-italic-webfont.woff) format('woff');
  }

  /*
 *                        ___
 *                       /\_ \
 *  _____     ___     ___\//\ \      __
 * /\ '__`\  / __`\  / __`\\ \ \   /'__`\
 * \ \ \_\ \/\ \_\ \/\ \_\ \\_\ \_/\  __/
 *  \ \ ,__/\ \____/\ \____//\____\ \____\
 *   \ \ \/  \/___/  \/___/ \/____/\/____/
 *    \ \_\
 *     \/_/
 *
 * Designed, built, and released under MIT license by @mdo. Learn more at
 * https://github.com/poole/poole.
 */


/*
 * Contents
 *
 * Body resets
 * Custom type
 * Messages
 * Container
 * Masthead
 * Posts and pages
 * Pagination
 * Reverse layout
 * Themes
 */


/*
 * Body resets
 *
 * Update the foundational and global aspects of the page.
 */

* {
  -webkit-box-sizing: border-box;
     -moz-box-sizing: border-box;
          box-sizing: border-box;
}

html,
body {
  margin: 0;
  padding: 0;
}

html {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 16px;
  line-height: 1.5;
}
@media (min-width: 38em) {
  html {
    font-size: 18px;
  }
}

body {
  color: #515151;
  background-color: #fff;
  -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
}

/* No `:visited` state is required by default (browsers will use `a`) */
a {
  color: #268bd2;
  text-decoration: none;
}
a strong {
  color: inherit;
}
/* `:focus` is linked to `:hover` for basic accessibility */
a:hover,
a:focus {
  text-decoration: underline;
}

/* Headings */
h1, h2, h3, h4, h5, h6 {
  margin-bottom: .5rem;
  font-weight: bold;
  line-height: 1.25;
  color: #313131;
  text-rendering: optimizeLegibility;
  clear: left;
}
h1 {
  font-size: 2rem;
}
h2 {
  margin-top: 1rem;
  font-size: 1.5rem;
}
h3 {
  margin-top: 1.5rem;
  font-size: 1.25rem;
}
h4, h5, h6 {
  margin-top: 1rem;
  font-size: 1rem;
}

/* Body text */
p {
  margin-top: 0;
  margin-bottom: 1rem;
}

strong {
  color: #303030;
}


/* Lists */
ul, ol, dl {
  margin-top: 0;
  margin-bottom: 1rem;
}

dt {
  font-weight: bold;
}
dd {
  margin-bottom: .5rem;
}

/* Misc */
hr {
  position: relative;
  margin: 1.5rem 0;
  border: 0;
  border-top: 1px solid #eee;
  border-bottom: 1px solid #fff;
}

abbr {
  font-size: 85%;
  font-weight: bold;
  color: #555;
  text-transform: uppercase;
}
abbr[title] {
  cursor: help;
  border-bottom: 1px dotted #e5e5e5;
}

/* Code */
code,
pre {
  font-family: Menlo, Monaco, "Courier New", monospace;
}
code {
  padding: .25em .5em;
  font-size: 85%;
  color: #bf616a;
  background-color: #f9f9f9;
  border-radius: 3px;
}
pre {
  display: block;
  margin-top: 0;
  margin-bottom: 1rem;
  padding: 1rem;
  font-size: .8rem;
  line-height: 1.4;
  white-space: pre;
  white-space: pre-wrap;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f9f9f9;
}
pre code {
  padding: 0;
  font-size: 100%;
  color: inherit;
  background-color: transparent;
}

/* Pygments via Jekyll */
.highlight {
  margin-bottom: 1rem;
  border-radius: 4px;
}
.highlight pre {
  margin-bottom: 0;
}

/* Gist via GitHub Pages */
.gist .gist-file {
  font-family: Menlo, Monaco, "Courier New", monospace !important;
}
.gist .markdown-body {
  padding: 15px;
}
.gist pre {
  padding: 0;
  background-color: transparent;
}
.gist .gist-file .gist-data {
  font-size: .8rem !important;
  line-height: 1.4;
}
.gist code {
  padding: 0;
  color: inherit;
  background-color: transparent;
  border-radius: 0;
}

/* Quotes */
blockquote {
  padding: .5rem 1rem;
  margin: .8rem 0;
  color: #7a7a7a;
  border-left: .25rem solid #e5e5e5;
}
blockquote p:last-child {
  margin-bottom: 0;
}
@media (min-width: 30em) {
  blockquote {
    padding-right: 5rem;
    padding-left: 1.25rem;
  }
}

img {
  display: block;
  max-width: 100%;
  margin: 0 0 1rem;
  border-radius: 5px;
}

/* Tables */
table {
  margin-bottom: 1rem;
  width: 100%;
  border: 1px solid #e5e5e5;
  border-collapse: collapse;
}
td,
th {
  padding: .25rem .5rem;
  border: 1px solid #e5e5e5;
}
tbody tr:nth-child(odd) td,
tbody tr:nth-child(odd) th {
  background-color: #f9f9f9;
}


/*
 * Custom type
 *
 * Extend paragraphs with `.lead` for larger introductory text.
 */

.lead {
  font-size: 1.25rem;
  font-weight: 300;
}


/*
 * Messages
 *
 * Show alert messages to users. You may add it to single elements like a `<p>`,
 * or to a parent if there are multiple elements to show.
 */

.message {
  margin-bottom: 1rem;
  padding: 1rem;
  color: #717171;
  background-color: #f9f9f9;
}


/*
 * Container
 *
 * Center the page content.
 */

.container {
  max-width: 38rem;
  padding-left:  1rem;
  padding-right: 1rem;
  margin-left:  auto;
  margin-right: auto;
}


/*
 * Masthead
 *
 * Super small header above the content for site name and short description.
 */

.masthead {
  padding-top:    1rem;
  padding-bottom: 1rem;
  margin-bottom: 3rem;
}
.masthead-title {
  margin-top: 0;
  margin-bottom: 0;
  color: #505050;
}
.masthead-title a {
  color: #505050;
}
.masthead-title small {
  font-size: 75%;
  font-weight: 400;
  color: #c0c0c0;
  letter-spacing: 0;
}


/*
 * Posts and pages
 *
 * Each post is wrapped in `.post` and is used on default and post layouts. Each
 * page is wrapped in `.page` and is only used on the page layout.
 */

.page,
.post {
  margin-bottom: 4em;
}

/* Blog post or page title */
.page-title,
.post-title,
.post-title a {
  color: #303030;
}
.page-title,
.post-title {
  margin-top: 0;
}

/* Meta data line below post title */
.post-date {
  display: block;
  margin-top: -.5rem;
  margin-bottom: 1rem;
  color: #9a9a9a;
}

/* Related posts */
.related {
  padding-top: 2rem;
  padding-bottom: 2rem;
  border-top: 1px solid #eee;
}
.related-posts {
  padding-left: 0;
  list-style: none;
}
.related-posts h3 {
  margin-top: 0;
}
.related-posts li small {
  font-size: 75%;
  color: #999;
}
.related-posts li a:hover {
  color: #268bd2;
  text-decoration: none;
}
.related-posts li a:hover small {
  color: inherit;
}


/*
 * Pagination
 *
 * Super lightweight (HTML-wise) blog pagination. `span`s are provide for when
 * there are no more previous or next posts to show.
 */

.pagination {
  overflow: hidden; /* clearfix */
  margin-left: -1rem;
  margin-right: -1rem;
  font-family: "PT Sans", Helvetica, Arial, sans-serif;
  color: #ccc;
  text-align: center;
}

/* Pagination items can be `span`s or `a`s */
.pagination-item {
  display: block;
  padding: 1rem;
  border: 1px solid #eee;
}
.pagination-item:first-child {
  margin-bottom: -1px;
}

/* Only provide a hover state for linked pagination items */
a.pagination-item:hover {
  background-color: #f5f5f5;
}

@media (min-width: 30em) {
  .pagination {
    margin: 3rem 0;
  }
  .pagination-item {
    float: left;
    width: 50%;
  }
  .pagination-item:first-child {
    margin-bottom: 0;
    border-top-left-radius:    4px;
    border-bottom-left-radius: 4px;
  }
  .pagination-item:last-child {
    margin-left: -1px;
    border-top-right-radius:    4px;
    border-bottom-right-radius: 4px;
  }
}

  .highlight .hll { background-color: #ffc; }
.highlight .c { color: #999; } /* Comment */
.highlight .err { color: #a00; background-color: #faa } /* Error */
.highlight .k { color: #069; } /* Keyword */
.highlight .o { color: #555 } /* Operator */
.highlight .cm { color: #09f; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #099 } /* Comment.Preproc */
.highlight .c1 { color: #999; } /* Comment.Single */
.highlight .cs { color: #999; } /* Comment.Special */
.highlight .gd { background-color: #fcc; border: 1px solid #c00 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #f00 } /* Generic.Error */
.highlight .gh { color: #030; } /* Generic.Heading */
.highlight .gi { background-color: #cfc; border: 1px solid #0c0 } /* Generic.Inserted */
.highlight .go { color: #aaa } /* Generic.Output */
.highlight .gp { color: #009; } /* Generic.Prompt */
.highlight .gs { } /* Generic.Strong */
.highlight .gu { color: #030; } /* Generic.Subheading */
.highlight .gt { color: #9c6 } /* Generic.Traceback */
.highlight .kc { color: #069; } /* Keyword.Constant */
.highlight .kd { color: #069; } /* Keyword.Declaration */
.highlight .kn { color: #069; } /* Keyword.Namespace */
.highlight .kp { color: #069 } /* Keyword.Pseudo */
.highlight .kr { color: #069; } /* Keyword.Reserved */
.highlight .kt { color: #078; } /* Keyword.Type */
.highlight .m { color: #f60 } /* Literal.Number */
.highlight .s { color: #d44950 } /* Literal.String */
.highlight .na { color: #4f9fcf } /* Name.Attribute */
.highlight .nb { color: #366 } /* Name.Builtin */
.highlight .nc { color: #0a8; } /* Name.Class */
.highlight .no { color: #360 } /* Name.Constant */
.highlight .nd { color: #99f } /* Name.Decorator */
.highlight .ni { color: #999; } /* Name.Entity */
.highlight .ne { color: #c00; } /* Name.Exception */
.highlight .nf { color: #c0f } /* Name.Function */
.highlight .nl { color: #99f } /* Name.Label */
.highlight .nn { color: #0cf; } /* Name.Namespace */
.highlight .nt { color: #2f6f9f; } /* Name.Tag */
.highlight .nv { color: #033 } /* Name.Variable */
.highlight .ow { color: #000; } /* Operator.Word */
.highlight .w { color: #bbb } /* Text.Whitespace */
.highlight .mf { color: #f60 } /* Literal.Number.Float */
.highlight .mh { color: #f60 } /* Literal.Number.Hex */
.highlight .mi { color: #f60 } /* Literal.Number.Integer */
.highlight .mo { color: #f60 } /* Literal.Number.Oct */
.highlight .sb { color: #c30 } /* Literal.String.Backtick */
.highlight .sc { color: #c30 } /* Literal.String.Char */
.highlight .sd { color: #c30; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #c30 } /* Literal.String.Double */
.highlight .se { color: #c30; } /* Literal.String.Escape */
.highlight .sh { color: #c30 } /* Literal.String.Heredoc */
.highlight .si { color: #a00 } /* Literal.String.Interpol */
.highlight .sx { color: #c30 } /* Literal.String.Other */
.highlight .sr { color: #3aa } /* Literal.String.Regex */
.highlight .s1 { color: #c30 } /* Literal.String.Single */
.highlight .ss { color: #fc3 } /* Literal.String.Symbol */
.highlight .bp { color: #366 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #033 } /* Name.Variable.Class */
.highlight .vg { color: #033 } /* Name.Variable.Global */
.highlight .vi { color: #033 } /* Name.Variable.Instance */
.highlight .il { color: #f60 } /* Literal.Number.Integer.Long */

.css .o,
.css .o + .nt,
.css .nt + .nt { color: #999; }
  /*
 *  __                  __
 * /\ \                /\ \
 * \ \ \___   __  __   \_\ \     __
 *  \ \  _ `\/\ \/\ \  /'_` \  /'__`\
 *   \ \ \ \ \ \ \_\ \/\ \_\ \/\  __/
 *    \ \_\ \_\/`____ \ \___,_\ \____\
 *     \/_/\/_/`/___/> \/__,_ /\/____/
 *                /\___/
 *                \/__/
 *
 * Designed, built, and released under MIT license by @mdo. Learn more at
 * https://github.com/poole/hyde.
 */


/*
 * Contents
 *
 * Global resets
 * Sidebar
 * Container
 * Reverse layout
 * Themes
 */


/*
 * Global resets
 *
 * Update the foundational and global aspects of the page.
 */

html {
  font-family: "PT Sans", Helvetica, Arial, sans-serif;
}
@media (min-width: 48em) {
  html {
    font-size: 16px;
  }
}
@media (min-width: 58em) {
  html {
    font-size: 18px;
  }
}


/*
 * Sidebar
 *
 * Flexible banner for housing site name, intro, and "footer" content. Starts
 * out above content in mobile and later moves to the side with wider viewports.
 */

.sidebar {
  text-align: center;
  padding: 2rem 1rem;
  color: rgba(255,255,255,.5);
  background-color: #202020;
}
.sidebar-mini {
  display: inline;
}
.sidebar-content {
  display: none;
}
@media (min-width: 48em) {
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 18rem;
    text-align: left;
  }
  .sidebar-mini {
	display: none;
  }
  .sidebar-content {
	display: inline;
  }
}

/* Sidebar links */
.sidebar a {
  color: #fff;
}

/* Sidebar nav */
.sidebar-nav {
  margin-bottom: 1rem;
}
.sidebar-nav-item {
  display: block;
  line-height: 1.75;
}
a.sidebar-nav-item:hover,
a.sidebar-nav-item:focus {
  text-decoration: underline;
}
.sidebar-nav-item.active {
  font-weight: bold;
}

/* Sticky sidebar
 *
 * Add the `sidebar-sticky` class to the sidebar's container to affix it the
 * contents to the bottom of the sidebar in tablets and up.
 */

@media (min-width: 48em) {
  .sidebar-sticky {
    position: absolute;
    right:  1rem;
    bottom: 1rem;
    left:   1rem;
  }
}


/* Container
 *
 * Align the contents of the site above the proper threshold with some margin-fu
 * with a 25%-wide `.sidebar`.
 */

.content {
  padding-top:    4rem;
  padding-bottom: 4rem;
}

@media (min-width: 48em) {
  .content {
    max-width: 38rem;
    margin-left: 20rem;
    margin-right: 2rem;
  }
}

@media (min-width: 64em) {
  .content {
    max-width: 48rem;
    margin-left: 22rem;
    margin-right: 4rem;
  }
}


/*
 * Reverse layout
 *
 * Flip the orientation of the page by placing the `.sidebar` on the right.
 */

@media (min-width: 48em) {
  .layout-reverse .sidebar {
    left: auto;
    right: 0;
  }
  .layout-reverse .content {
    margin-left: 2rem;
    margin-right: 20rem;
  }
}

@media (min-width: 64em) {
  .layout-reverse .content {
    margin-left: 4rem;
    margin-right: 22rem;
  }
}



/*
 * Themes
 *
 * As of v1.1, Hyde includes optional themes to color the sidebar and links
 * within blog posts. To use, add the class of your choosing to the `body`.
 */

/* Base16 (http://chriskempson.github.io/base16/#default) */

/* Red */
.theme-base-08 .sidebar {
  background-color: #ac4142;
}
.theme-base-08 .content a,
.theme-base-08 .related-posts li a:hover {
  color: #ac4142;
}

/* Orange */
.theme-base-09 .sidebar {
  background-color: #d28445;
}
.theme-base-09 .content a,
.theme-base-09 .related-posts li a:hover {
  color: #d28445;
}

/* Yellow */
.theme-base-0a .sidebar {
  background-color: #f4bf75;
}
.theme-base-0a .content a,
.theme-base-0a .related-posts li a:hover {
  color: #f4bf75;
}

/* Green */
.theme-base-0b .sidebar {
  background-color: #90a959;
}
.theme-base-0b .content a,
.theme-base-0b .related-posts li a:hover {
  color: #90a959;
}

/* Cyan */
.theme-base-0c .sidebar {
  background-color: #75b5aa;
}
.theme-base-0c .content a,
.theme-base-0c .related-posts li a:hover {
  color: #75b5aa;
}

/* Blue */
.theme-base-0d .sidebar {
  background-color: #6a9fb5;
}
.theme-base-0d .content a,
.theme-base-0d .related-posts li a:hover {
  color: #6a9fb5;
}

/* Magenta */
.theme-base-0e .sidebar {
  background-color: #aa759f;
}
.theme-base-0e .content a,
.theme-base-0e .related-posts li a:hover {
  color: #aa759f;
}

/* Brown */
.theme-base-0f .sidebar {
  background-color: #8f5536;
}
.theme-base-0f .content a,
.theme-base-0f .related-posts li a:hover {
  color: #8f5536;
}

  </style>

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed/">

  

  
  
</head>
<body>
<div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      <p class="lead"><a href="/"><nobr>Hacking a day at a time üçµ </nobr></a></p>
    </div>

    
    <div class="sidebar-mini">
	    Ben&nbsp;Young&nbsp;Mwanzia&nbsp;<br/>
        <small>
          &nbsp;<a href="https://www.linkedin.com/in/bynmz/"><img src="/images/linkedin.svg" width="16" height="16" style="display: inline; vertical-align: -21px;" /></a>,
          &nbsp;<a href="https://github.com/bynmz"><img src="/images/github-mark-white.svg" width="16" height="16" style="display: inline; vertical-align: -21px;" /></a>,
          &nbsp;<a href="mailto:bynmwz@gmail.com">email</a>,
          &nbsp;<a href="https://twitter.com/_benng__"><img src="/images/X_logo_2023.svg" width="20" height="20" style="display: inline; vertical-align: -22px;" /></a>,
          &nbsp;<a href="https://www.youtube.com/@benng5517"><img src="/images/youtube.svg" width="20" height="20" style="display: inline; vertical-align: -22px;" /></a>
        </small>
    </div>

    <div class="sidebar-content">
    
      <h4>Posts Author</h4>
      <p>
        Ben&nbsp;Young&nbsp;Mwanzia&nbsp;<br/>
        <small>
          &nbsp;<a href="https://www.linkedin.com/in/bynmz/"><img src="/images/linkedin.svg" width="16" height="16" style="display: inline; vertical-align: -21px;" /></a>,
          &nbsp;<a href="https://github.com/bynmz"><img src="/images/github-mark-white.svg" width="16" height="16" style="display: inline; vertical-align: -21px;" /></a>,
          &nbsp;<a href="mailto:bynmwz@gmail.com">email</a>,
          &nbsp;<a href="https://twitter.com/_benng__"><img src="/images/X_logo_2023.svg" width="16" height="16" style="display: inline; vertical-align: -22px;" /></a>,
          &nbsp;<a href="https://www.youtube.com/@benng5517"><img src="/images/youtube.svg" width="16" height="16" style="display: inline; vertical-align: -22px;" /></a>
        </small>
      </p>
      <p>
      <a href="/about/">Work and about</a>
      </p>

      <h4>Posts</h4>
      <p>
      If you like this blog, you should follow it <a href="/feed/">via RSS</a> and read <a href="/archives/">older posts</a>. Here are the recent posts:
      </p>
      <ul style="padding-left: 20px;">
      
        <li>
          <small><a href="/2024/03/28/offscreen-rendering-in-vulkan/">Offscreen rendering in Vulkan</a></small>
        </li>
      
        <li>
          <small><a href="/2024/02/05/simple-ui-with-dear-imgui/">Simple UI with Dear Imgui</a></small>
        </li>
      
      </ul>
    </div>
  </div>
</div>
<div class="content container">

<table>
<tr>
 
<td style="border: 0; text-align: left;">
<a class="prev" href="/2024/02/05/simple-ui-with-dear-imgui/">&laquo;&nbsp;Simple UI with Dear Imgui</a>
</td>
 
 
</tr>
</table>
<div class="post">
<h1 class="post-title">Offscreen rendering in Vulkan</h1>
<span class="post-date">

28 Mar 2024

</span>
<p>In the <a href="https://bynmz.github.io/2024/02/05/simple-ui-with-dear-imgui/">last post</a> we looked at integrating a simple UI with Dear Imgui using my <a href="https://github.com/bynmz/mygraphicsengine" target="_blank">vulkan renderer</a>. Now we shall look at offscreen rendering. This can be used for various purposes such as post-processing effects, rendering to textures for later use, shadow mapping, reflections etc. In this example we shall look at offscreen rendering for reflections. After having a decent understanding of the Vulkan specification and having gone through the renderer sample code provided, you can follow along or use this as a general guide on how you can implement this in your own projects. The intention of this is not to serve as a tutorial for beginners but as a guide for someone with a good enough understanding of the Vulkan specification and some modern C++ knowledge.</p>

<p>To start, I encapsulated the following into a new <code class="language-plaintext highlighter-rouge">offScreen.cpp</code> class;</p>

<p>In the constructor I initialize the offscreen renderer with a specified device and set the width and height of the offscreen framebuffer. This also calls the <code class="language-plaintext highlighter-rouge">init()</code> function to perform initialization tasks.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">OffScreen</span><span class="o">::</span><span class="n">OffScreen</span><span class="p">(</span><span class="n">Device</span> <span class="o">&amp;</span><span class="n">deviceRef</span><span class="p">)</span>
<span class="o">:</span> <span class="n">device</span><span class="p">{</span><span class="n">deviceRef</span><span class="p">}</span>
<span class="p">{</span>
    <span class="n">offscreenPass</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">FB_DIM</span><span class="p">;</span>
    <span class="n">offscreenPass</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">FB_DIM</span><span class="p">;</span>
    <span class="n">init</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The init() method calls various functions to create the necessary Vulkan objects for offscreen rendering, such as images, image views, samplers, depth resources, render passes and framebuffers. The descriptor is also updated with the image layout for later use in a descriptor set.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">OffScreen</span><span class="o">::</span><span class="n">init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">createImage</span><span class="p">();</span>
    <span class="n">createImageView</span><span class="p">();</span>
    <span class="n">createSampler</span><span class="p">();</span>
    <span class="n">createDepthResources</span><span class="p">();</span>
    <span class="n">createRenderPass</span><span class="p">();</span>
    <span class="n">createFramebuffers</span><span class="p">();</span>
    <span class="n">updateDescriptor</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The destructor destroys Vulkan objects created during initialization, such as samplers, image views, images, memory, framebuffers and render passes.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">OffScreen</span><span class="o">::~</span><span class="n">OffScreen</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// Sampler</span>
  <span class="n">vkDestroySampler</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">sampler</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>

  <span class="c1">// Color attachment</span>
  <span class="n">vkDestroyImageView</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">view</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
  <span class="n">vkDestroyImage</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">image</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
  <span class="n">vkFreeMemory</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>

  <span class="c1">// vkDestroyBuffer(device.device(), offscreenPass.color.staging, nullptr);</span>
  <span class="n">vkDestroyFramebuffer</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">frameBuffer</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>

  <span class="n">vkDestroyRenderPass</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">renderPass</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>

  <span class="c1">// Depth attachment</span>
  <span class="n">vkDestroyImageView</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">depth</span><span class="p">.</span><span class="n">view</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
  <span class="n">vkDestroyImage</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">depth</span><span class="p">.</span><span class="n">image</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
  <span class="n">vkFreeMemory</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">depth</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The updateDescriptor() method fills a descriptor structure with information about the offscreen color image, including its layout and sampler.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">OffScreen</span><span class="o">::</span><span class="n">updateDescriptor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">offscreenPass</span><span class="p">.</span><span class="n">descriptor</span><span class="p">.</span><span class="n">imageLayout</span> <span class="o">=</span> <span class="n">VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL</span><span class="p">;</span>
  <span class="n">offscreenPass</span><span class="p">.</span><span class="n">descriptor</span><span class="p">.</span><span class="n">imageView</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">view</span><span class="p">;</span>
  <span class="n">offscreenPass</span><span class="p">.</span><span class="n">descriptor</span><span class="p">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">sampler</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Next, a Vulkan image object representing the offscreen color attachment is created. The format, extend, usage and memory properties of the image are also specified.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">OffScreen</span><span class="o">::</span><span class="n">createImage</span><span class="p">()</span> <span class="p">{</span>
  		<span class="c1">// Color attachment</span>
		<span class="n">VkImageCreateInfo</span> <span class="n">image</span><span class="p">{};</span>
    <span class="n">image</span><span class="p">.</span><span class="n">sType</span> <span class="o">=</span> <span class="n">VK_STRUCTURE_TYPE_IMAGE_CREATE_INFO</span><span class="p">;</span>
		<span class="n">image</span><span class="p">.</span><span class="n">imageType</span> <span class="o">=</span> <span class="n">VK_IMAGE_TYPE_2D</span><span class="p">;</span>
		<span class="n">image</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FB_COLOR_FORMAT</span><span class="p">;</span>
		<span class="n">image</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">image</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">image</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">image</span><span class="p">.</span><span class="n">mipLevels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">image</span><span class="p">.</span><span class="n">arrayLayers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">image</span><span class="p">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">VK_SAMPLE_COUNT_1_BIT</span><span class="p">;</span>
		<span class="n">image</span><span class="p">.</span><span class="n">tiling</span> <span class="o">=</span> <span class="n">VK_IMAGE_TILING_OPTIMAL</span><span class="p">;</span>
		<span class="c1">// We will sample directly from the color attachment</span>
		<span class="n">image</span><span class="p">.</span><span class="n">usage</span> <span class="o">=</span> <span class="n">VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT</span> <span class="o">|</span> <span class="n">VK_IMAGE_USAGE_SAMPLED_BIT</span><span class="p">;</span>

    <span class="n">device</span><span class="p">.</span><span class="n">createImageWithInfo</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span>
        <span class="n">VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT</span><span class="p">,</span>
        <span class="n">offscreenPass</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">image</span><span class="p">,</span>
        <span class="n">offscreenPass</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">mem</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The Vulkan image view object is created for the offscreen color image. The format and subresource range of the image view is also specified.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">OffScreen</span><span class="o">::</span><span class="n">createImageView</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">VkImageViewCreateInfo</span> <span class="n">viewInfo</span><span class="p">{};</span>
    <span class="n">viewInfo</span><span class="p">.</span><span class="n">sType</span> <span class="o">=</span> <span class="n">VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO</span><span class="p">;</span>
    <span class="n">viewInfo</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">image</span><span class="p">;</span>
    <span class="n">viewInfo</span><span class="p">.</span><span class="n">viewType</span> <span class="o">=</span> <span class="n">VK_IMAGE_VIEW_TYPE_2D</span><span class="p">;</span>
    <span class="n">viewInfo</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FB_COLOR_FORMAT</span><span class="p">;</span>
    <span class="n">viewInfo</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">aspectMask</span> <span class="o">=</span> <span class="n">VK_IMAGE_ASPECT_COLOR_BIT</span><span class="p">;</span>
    <span class="n">viewInfo</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">baseMipLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">viewInfo</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">levelCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">viewInfo</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">baseArrayLayer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">viewInfo</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">layerCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">vkCreateImageView</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">viewInfo</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">view</span><span class="p">)</span> <span class="o">!=</span>
        <span class="n">VK_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">"failed to create texture image view!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Create a Vulkan sampler object for sampling the offscreen color image. Parameters such as filtering, addressing mode and mipmapping are also specified.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">OffScreen</span><span class="o">::</span><span class="n">createSampler</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">VkSamplerCreateInfo</span> <span class="n">samplerInfo</span><span class="p">{};</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">sType</span> <span class="o">=</span> <span class="n">VK_STRUCTURE_TYPE_SAMPLER_CREATE_INFO</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">magFilter</span> <span class="o">=</span> <span class="n">VK_FILTER_LINEAR</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">minFilter</span> <span class="o">=</span> <span class="n">VK_FILTER_LINEAR</span><span class="p">;</span>

      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">addressModeU</span> <span class="o">=</span> <span class="n">VK_SAMPLER_ADDRESS_MODE_CLAMP_TO_EDGE</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">addressModeV</span> <span class="o">=</span> <span class="n">samplerInfo</span><span class="p">.</span><span class="n">addressModeU</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">addressModeW</span> <span class="o">=</span> <span class="n">samplerInfo</span><span class="p">.</span><span class="n">addressModeU</span><span class="p">;</span>

      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">anisotropyEnable</span> <span class="o">=</span> <span class="n">VK_TRUE</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">maxAnisotropy</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">borderColor</span> <span class="o">=</span> <span class="n">VK_BORDER_COLOR_FLOAT_OPAQUE_WHITE</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">unnormalizedCoordinates</span> <span class="o">=</span> <span class="n">VK_FALSE</span><span class="p">;</span>

      <span class="c1">// these fields useful for percentage close filtering for shadow maps</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">compareEnable</span> <span class="o">=</span> <span class="n">VK_FALSE</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">compareOp</span> <span class="o">=</span> <span class="n">VK_COMPARE_OP_ALWAYS</span><span class="p">;</span>

      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">mipmapMode</span> <span class="o">=</span> <span class="n">VK_SAMPLER_MIPMAP_MODE_LINEAR</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">mipLodBias</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">minLod</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
      <span class="n">samplerInfo</span><span class="p">.</span><span class="n">maxLod</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">vkCreateSampler</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">samplerInfo</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">sampler</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VK_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">"failed to create texture sampler!"</span><span class="p">);</span>
      <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>A Vulkan render pass object is created for defining the sequence of rendering operations. Attachment descriptions for color and depth attachments are specified. Subpasses and dependencies between rendering operations are defined.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">OffScreen</span><span class="o">::</span><span class="n">createRenderPass</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">VkAttachmentDescription</span> <span class="n">depthAttachment</span><span class="p">{};</span>
  <span class="n">depthAttachment</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">findDepthFormat</span><span class="p">();</span>
  <span class="n">depthAttachment</span><span class="p">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">VK_SAMPLE_COUNT_1_BIT</span><span class="p">;</span>
  <span class="n">depthAttachment</span><span class="p">.</span><span class="n">loadOp</span> <span class="o">=</span> <span class="n">VK_ATTACHMENT_LOAD_OP_CLEAR</span><span class="p">;</span>
  <span class="n">depthAttachment</span><span class="p">.</span><span class="n">storeOp</span> <span class="o">=</span> <span class="n">VK_ATTACHMENT_STORE_OP_DONT_CARE</span><span class="p">;</span>
  <span class="n">depthAttachment</span><span class="p">.</span><span class="n">stencilLoadOp</span> <span class="o">=</span> <span class="n">VK_ATTACHMENT_LOAD_OP_DONT_CARE</span><span class="p">;</span>
  <span class="n">depthAttachment</span><span class="p">.</span><span class="n">stencilStoreOp</span> <span class="o">=</span> <span class="n">VK_ATTACHMENT_STORE_OP_DONT_CARE</span><span class="p">;</span>
  <span class="n">depthAttachment</span><span class="p">.</span><span class="n">initialLayout</span> <span class="o">=</span> <span class="n">VK_IMAGE_LAYOUT_UNDEFINED</span><span class="p">;</span>
  <span class="n">depthAttachment</span><span class="p">.</span><span class="n">finalLayout</span> <span class="o">=</span> <span class="n">VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL</span><span class="p">;</span>

  <span class="n">VkAttachmentReference</span> <span class="n">depthAttachmentRef</span><span class="p">{};</span>
  <span class="n">depthAttachmentRef</span><span class="p">.</span><span class="n">attachment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">depthAttachmentRef</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL</span><span class="p">;</span>

  <span class="n">VkAttachmentDescription</span> <span class="n">colorAttachment</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="n">colorAttachment</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FB_COLOR_FORMAT</span><span class="p">;</span>
  <span class="n">colorAttachment</span><span class="p">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">VK_SAMPLE_COUNT_1_BIT</span><span class="p">;</span>
  <span class="n">colorAttachment</span><span class="p">.</span><span class="n">loadOp</span> <span class="o">=</span> <span class="n">VK_ATTACHMENT_LOAD_OP_CLEAR</span><span class="p">;</span>
  <span class="n">colorAttachment</span><span class="p">.</span><span class="n">storeOp</span> <span class="o">=</span> <span class="n">VK_ATTACHMENT_STORE_OP_STORE</span><span class="p">;</span>
  <span class="n">colorAttachment</span><span class="p">.</span><span class="n">stencilStoreOp</span> <span class="o">=</span> <span class="n">VK_ATTACHMENT_STORE_OP_DONT_CARE</span><span class="p">;</span>
  <span class="n">colorAttachment</span><span class="p">.</span><span class="n">stencilLoadOp</span> <span class="o">=</span> <span class="n">VK_ATTACHMENT_LOAD_OP_DONT_CARE</span><span class="p">;</span>
  <span class="n">colorAttachment</span><span class="p">.</span><span class="n">initialLayout</span> <span class="o">=</span> <span class="n">VK_IMAGE_LAYOUT_UNDEFINED</span><span class="p">;</span>
  <span class="n">colorAttachment</span><span class="p">.</span><span class="n">finalLayout</span> <span class="o">=</span> <span class="n">VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL</span><span class="p">;</span>

  <span class="n">VkAttachmentReference</span> <span class="n">colorAttachmentRef</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="n">colorAttachmentRef</span><span class="p">.</span><span class="n">attachment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">colorAttachmentRef</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL</span><span class="p">;</span>

  <span class="n">VkSubpassDescription</span> <span class="n">subpass</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="n">subpass</span><span class="p">.</span><span class="n">pipelineBindPoint</span> <span class="o">=</span> <span class="n">VK_PIPELINE_BIND_POINT_GRAPHICS</span><span class="p">;</span>
  <span class="n">subpass</span><span class="p">.</span><span class="n">colorAttachmentCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">subpass</span><span class="p">.</span><span class="n">pColorAttachments</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">colorAttachmentRef</span><span class="p">;</span>
  <span class="n">subpass</span><span class="p">.</span><span class="n">pDepthStencilAttachment</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">depthAttachmentRef</span><span class="p">;</span>

  <span class="c1">// Use subpass dependencies for layout transitions</span>
  <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">VkSubpassDependency</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">dependencies</span><span class="p">;</span>

  <span class="n">dependencies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">srcSubpass</span> <span class="o">=</span> <span class="n">VK_SUBPASS_EXTERNAL</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dstSubpass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">srcStageMask</span> <span class="o">=</span> <span class="n">VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dstStageMask</span> <span class="o">=</span> <span class="n">VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT</span> <span class="o">|</span> <span class="n">VK_PIPELINE_STAGE_EARLY_FRAGMENT_TESTS_BIT</span> <span class="o">|</span> <span class="n">VK_PIPELINE_STAGE_LATE_FRAGMENT_TESTS_BIT</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">srcAccessMask</span> <span class="o">=</span> <span class="n">VK_ACCESS_NONE_KHR</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dstAccessMask</span> <span class="o">=</span> <span class="n">VK_ACCESS_COLOR_ATTACHMENT_READ_BIT</span> <span class="o">|</span> <span class="n">VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT</span> <span class="o">|</span> <span class="n">VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_READ_BIT</span> <span class="o">|</span> <span class="n">VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_WRITE_BIT</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dependencyFlags</span> <span class="o">=</span> <span class="n">VK_DEPENDENCY_BY_REGION_BIT</span><span class="p">;</span>

  <span class="n">dependencies</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">srcSubpass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dstSubpass</span> <span class="o">=</span> <span class="n">VK_SUBPASS_EXTERNAL</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">srcStageMask</span> <span class="o">=</span> <span class="n">VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT</span> <span class="o">|</span> <span class="n">VK_PIPELINE_STAGE_EARLY_FRAGMENT_TESTS_BIT</span> <span class="o">|</span> <span class="n">VK_PIPELINE_STAGE_LATE_FRAGMENT_TESTS_BIT</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dstStageMask</span> <span class="o">=</span> <span class="n">VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">srcAccessMask</span> <span class="o">=</span> <span class="n">VK_ACCESS_COLOR_ATTACHMENT_READ_BIT</span> <span class="o">|</span> <span class="n">VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT</span> <span class="o">|</span> <span class="n">VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_READ_BIT</span> <span class="o">|</span> <span class="n">VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_WRITE_BIT</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dstAccessMask</span> <span class="o">=</span> <span class="n">VK_ACCESS_MEMORY_READ_BIT</span><span class="p">;</span>
  <span class="n">dependencies</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dependencyFlags</span> <span class="o">=</span> <span class="n">VK_DEPENDENCY_BY_REGION_BIT</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">VkAttachmentDescription</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">attachments</span> <span class="o">=</span> <span class="p">{</span><span class="n">colorAttachment</span><span class="p">,</span> <span class="n">depthAttachment</span><span class="p">};</span>
  <span class="n">VkRenderPassCreateInfo</span> <span class="n">renderPassInfo</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">sType</span> <span class="o">=</span> <span class="n">VK_STRUCTURE_TYPE_RENDER_PASS_CREATE_INFO</span><span class="p">;</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">attachmentCount</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">attachments</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">pAttachments</span> <span class="o">=</span> <span class="n">attachments</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">subpassCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">pSubpasses</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">subpass</span><span class="p">;</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">dependencyCount</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dependencies</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">pDependencies</span> <span class="o">=</span> <span class="n">dependencies</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">vkCreateRenderPass</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">renderPassInfo</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">renderPass</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VK_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">"failed to create render pass!"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Create Vulkan framebuffer objects for rending into the offscreen color and depth attachments. This associates the framebuffers with the render pass.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">OffScreen</span><span class="o">::</span><span class="n">createFramebuffers</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">VkImageView</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">attachments</span> <span class="o">=</span> <span class="p">{</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">view</span><span class="p">,</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">depth</span><span class="p">.</span><span class="n">view</span><span class="p">};</span>

  <span class="n">VkFramebufferCreateInfo</span> <span class="n">framebufferInfo</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="n">framebufferInfo</span><span class="p">.</span><span class="n">sType</span> <span class="o">=</span> <span class="n">VK_STRUCTURE_TYPE_FRAMEBUFFER_CREATE_INFO</span><span class="p">;</span>
  <span class="n">framebufferInfo</span><span class="p">.</span><span class="n">renderPass</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">renderPass</span><span class="p">;</span>
  <span class="n">framebufferInfo</span><span class="p">.</span><span class="n">attachmentCount</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">attachments</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">framebufferInfo</span><span class="p">.</span><span class="n">pAttachments</span> <span class="o">=</span> <span class="n">attachments</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
  <span class="n">framebufferInfo</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
  <span class="n">framebufferInfo</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
  <span class="n">framebufferInfo</span><span class="p">.</span><span class="n">layers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">vkCreateFramebuffer</span><span class="p">(</span>
          <span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span>
          <span class="o">&amp;</span><span class="n">framebufferInfo</span><span class="p">,</span>
          <span class="nb">nullptr</span><span class="p">,</span>
          <span class="o">&amp;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">frameBuffer</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VK_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">"failed to create framebuffer!"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Create a Vulkan image object representing the offscreen depth attachment, create a Vulkan image view object for the depth attachment and specifies the format, extent, usage and memory properties of the depth image.</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">OffScreen</span><span class="o">::</span><span class="n">createDepthResources</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">VkFormat</span> <span class="n">depthFormat</span> <span class="o">=</span> <span class="n">findDepthFormat</span><span class="p">();</span>
    <span class="c1">// Color attachment</span>
    <span class="n">VkImageCreateInfo</span> <span class="n">imageInfo</span><span class="p">{};</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">sType</span> <span class="o">=</span> <span class="n">VK_STRUCTURE_TYPE_IMAGE_CREATE_INFO</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">imageType</span> <span class="o">=</span> <span class="n">VK_IMAGE_TYPE_2D</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">mipLevels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">arrayLayers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">depthFormat</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">tiling</span> <span class="o">=</span> <span class="n">VK_IMAGE_TILING_OPTIMAL</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">initialLayout</span> <span class="o">=</span> <span class="n">VK_IMAGE_LAYOUT_UNDEFINED</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">usage</span> <span class="o">=</span> <span class="n">VK_IMAGE_USAGE_DEPTH_STENCIL_ATTACHMENT_BIT</span><span class="p">;</span>
    <span class="n">imageInfo</span><span class="p">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">VK_SAMPLE_COUNT_1_BIT</span><span class="p">;</span>

    <span class="n">device</span><span class="p">.</span><span class="n">createImageWithInfo</span><span class="p">(</span>
        <span class="n">imageInfo</span><span class="p">,</span>
        <span class="n">VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT</span><span class="p">,</span>
        <span class="n">offscreenPass</span><span class="p">.</span><span class="n">depth</span><span class="p">.</span><span class="n">image</span><span class="p">,</span>
        <span class="n">offscreenPass</span><span class="p">.</span><span class="n">depth</span><span class="p">.</span><span class="n">mem</span><span class="p">);</span>

    <span class="c1">// Depth stencil attachment</span>
    <span class="n">VkImageViewCreateInfo</span> <span class="n">depthStencilView</span><span class="p">{};</span>
    <span class="n">depthStencilView</span><span class="p">.</span><span class="n">sType</span> <span class="o">=</span> <span class="n">VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO</span><span class="p">;</span>
    <span class="n">depthStencilView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">offscreenPass</span><span class="p">.</span><span class="n">depth</span><span class="p">.</span><span class="n">image</span><span class="p">;</span>
    <span class="n">depthStencilView</span><span class="p">.</span><span class="n">viewType</span> <span class="o">=</span> <span class="n">VK_IMAGE_VIEW_TYPE_2D</span><span class="p">;</span>
    <span class="n">depthStencilView</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">depthFormat</span><span class="p">;</span>
    <span class="n">depthStencilView</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">aspectMask</span> <span class="o">=</span> <span class="n">VK_IMAGE_ASPECT_DEPTH_BIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">depthFormat</span> <span class="o">&gt;=</span> <span class="n">VK_FORMAT_D16_UNORM_S8_UINT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">depthStencilView</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">aspectMask</span> <span class="o">|=</span> <span class="n">VK_IMAGE_ASPECT_STENCIL_BIT</span><span class="p">;</span>
		<span class="p">}</span>
    <span class="n">depthStencilView</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">baseMipLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">depthStencilView</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">levelCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">depthStencilView</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">baseArrayLayer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">depthStencilView</span><span class="p">.</span><span class="n">subresourceRange</span><span class="p">.</span><span class="n">layerCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">vkCreateImageView</span><span class="p">(</span><span class="n">device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">depthStencilView</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">depth</span><span class="p">.</span><span class="n">view</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VK_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">"failed to create texture image view!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">VkFormat</span> <span class="n">OffScreen</span><span class="o">::</span><span class="n">findDepthFormat</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">device</span><span class="p">.</span><span class="n">findSupportedFormat</span><span class="p">(</span>
      <span class="p">{</span><span class="n">VK_FORMAT_D32_SFLOAT</span><span class="p">,</span> <span class="n">VK_FORMAT_D32_SFLOAT_S8_UINT</span><span class="p">,</span> <span class="n">VK_FORMAT_D24_UNORM_S8_UINT</span><span class="p">},</span>
      <span class="n">VK_IMAGE_TILING_OPTIMAL</span><span class="p">,</span>
      <span class="n">VK_FORMAT_FEATURE_DEPTH_STENCIL_ATTACHMENT_BIT</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>In the renderer class <code class="language-plaintext highlighter-rouge">renderer.cpp</code>, we can create an offscreen object.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">Renderer</span><span class="o">::</span><span class="n">createOffScreen</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">OffScreen</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">OffScreen</span><span class="o">&gt;</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>To begin and end the offscreen renderpass</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">Renderer</span><span class="o">::</span><span class="n">beginOffScreenRenderPass</span><span class="p">(</span><span class="n">VkCommandBuffer</span> <span class="n">commandBuffer</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">isFrameStarted</span> <span class="o">&amp;&amp;</span> <span class="s">"Can't call beginSwapChainRenderPass if frame is not in progress"</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span>
      <span class="n">commandBuffer</span> <span class="o">==</span> <span class="n">getCurrentCommandBuffer</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
      <span class="s">"Can't begin render pass on command buffer from a different frame"</span><span class="p">);</span>
  <span class="n">VkRenderPassBeginInfo</span> <span class="n">renderPassInfo</span><span class="p">{};</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">sType</span> <span class="o">=</span> <span class="n">VK_STRUCTURE_TYPE_RENDER_PASS_BEGIN_INFO</span><span class="p">;</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">renderPass</span> <span class="o">=</span> <span class="n">OffScreen</span><span class="o">-&gt;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">renderPass</span><span class="p">;</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">framebuffer</span> <span class="o">=</span> <span class="n">OffScreen</span><span class="o">-&gt;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">frameBuffer</span><span class="p">;</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">renderArea</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">renderArea</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">OffScreen</span><span class="o">-&gt;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">renderArea</span><span class="p">.</span><span class="n">extent</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">OffScreen</span><span class="o">-&gt;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
  <span class="n">clearValues</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">color</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.01</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.01</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.01</span><span class="n">f</span><span class="p">,</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">};</span>
  <span class="n">clearValues</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">depthStencil</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">clearValueCount</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">clearValues</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">renderPassInfo</span><span class="p">.</span><span class="n">pClearValues</span> <span class="o">=</span> <span class="n">clearValues</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>

  <span class="n">vkCmdBeginRenderPass</span><span class="p">(</span><span class="n">commandBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">renderPassInfo</span><span class="p">,</span> <span class="n">VK_SUBPASS_CONTENTS_INLINE</span><span class="p">);</span>

  <span class="n">VkViewport</span> <span class="n">viewport</span><span class="p">{};</span>
  <span class="n">viewport</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
  <span class="n">viewport</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
  <span class="n">viewport</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OffScreen</span><span class="o">-&gt;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
  <span class="n">viewport</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OffScreen</span><span class="o">-&gt;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
  <span class="n">viewport</span><span class="p">.</span><span class="n">minDepth</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
  <span class="n">viewport</span><span class="p">.</span><span class="n">maxDepth</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">;</span>
  <span class="n">VkRect2D</span> <span class="n">scissor</span><span class="p">{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">OffScreen</span><span class="o">-&gt;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">OffScreen</span><span class="o">-&gt;</span><span class="n">offscreenPass</span><span class="p">.</span><span class="n">height</span><span class="p">}};</span>
  <span class="n">vkCmdSetViewport</span><span class="p">(</span><span class="n">commandBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">viewport</span><span class="p">);</span>
  <span class="n">vkCmdSetScissor</span><span class="p">(</span><span class="n">commandBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scissor</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Renderer</span><span class="o">::</span><span class="n">endOffScreenRenderPass</span><span class="p">(</span><span class="n">VkCommandBuffer</span> <span class="n">commandBuffer</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">isFrameStarted</span> <span class="o">&amp;&amp;</span> <span class="s">"Can't call endOffScreenRenderPass if frame is not in progress"</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span>
      <span class="n">commandBuffer</span> <span class="o">==</span> <span class="n">getCurrentCommandBuffer</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
      <span class="s">"Can't end render pass on command buffer from a different frame"</span><span class="p">);</span>
  <span class="n">vkCmdEndRenderPass</span><span class="p">(</span><span class="n">commandBuffer</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Now we can call these methods in our app <code class="language-plaintext highlighter-rouge">App3D.cpp</code>. I use a global descriptor pool, descriptor set layout, and uniform buffer objects (UBOs) for each frame in flight. If you are not familiar with these concepts you can read more about them <a href="https://vulkan-tutorial.com/Uniform_buffers/Descriptor_pool_and_sets" target="_blank">here</a>.</p>

<p>In the interest of keeping this post short, the code for implementing them can be found <a href="https://gist.github.com/bynmz/35254c4a22aa832412c1fabefb71ebce" target="_blank">here</a>.</p>

<p>Back to our app <code class="language-plaintext highlighter-rouge">App3D.cpp</code></p>

<p>Initialize a RenderSystem object for our pipeline creation and rendering. This expects a device, a swapchain/ offscreen renderpass and a global descriptor set layout</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">App3D</span><span class="o">::</span><span class="n">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RenderSystem3D</span> <span class="n">objMirrored</span><span class="p">{</span>
      <span class="n">device</span><span class="p">,</span>
      <span class="n">Renderer</span><span class="p">.</span><span class="n">getOffScreenRenderPass</span><span class="p">(),</span>
      <span class="n">globalSetLayout</span><span class="o">-&gt;</span><span class="n">getDescriptorSetLayout</span><span class="p">()};</span>
  <span class="n">RenderSystem3D</span> <span class="n">objSystem</span><span class="p">{</span>
      <span class="n">device</span><span class="p">,</span>
      <span class="n">Renderer</span><span class="p">.</span><span class="n">getSwapChainRenderPass</span><span class="p">(),</span>
      <span class="n">globalSetLayout</span><span class="o">-&gt;</span><span class="n">getDescriptorSetLayout</span><span class="p">()};</span>
  <span class="n">PointLightSystem</span> <span class="n">pointLightMirrored</span><span class="p">{</span>
      <span class="n">device</span><span class="p">,</span>
      <span class="n">Renderer</span><span class="p">.</span><span class="n">getOffScreenRenderPass</span><span class="p">(),</span>
      <span class="n">globalSetLayout</span><span class="o">-&gt;</span><span class="n">getDescriptorSetLayout</span><span class="p">()};</span>
  <span class="n">PointLightSystem</span> <span class="n">pointLightSystem</span><span class="p">{</span>
      <span class="n">device</span><span class="p">,</span>
      <span class="n">Renderer</span><span class="p">.</span><span class="n">getSwapChainRenderPass</span><span class="p">(),</span>
      <span class="n">globalSetLayout</span><span class="o">-&gt;</span><span class="n">getDescriptorSetLayout</span><span class="p">()};</span>
  <span class="n">MirrorSystem</span> <span class="n">mirrorSystem</span><span class="p">{</span>
      <span class="n">device</span><span class="p">,</span>
      <span class="n">Renderer</span><span class="p">.</span><span class="n">getSwapChainRenderPass</span><span class="p">(),</span>
      <span class="n">globalSetLayout</span><span class="o">-&gt;</span><span class="n">getDescriptorSetLayout</span><span class="p">()</span>
  <span class="p">};</span>

    <span class="p">...</span>

  <span class="c1">// Main rendering loop</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Window</span><span class="p">.</span><span class="n">shouldClose</span><span class="p">())</span> <span class="p">{</span>
    <span class="p">...</span>
      <span class="c1">// Begin offscreen rendering pass for mirror effects.</span>
      <span class="n">Renderer</span><span class="p">.</span><span class="n">beginOffScreenRenderPass</span><span class="p">(</span><span class="n">commandBuffer</span><span class="p">);</span>
      <span class="n">objMirrored</span><span class="p">.</span><span class="n">renderGameObjects</span><span class="p">(</span><span class="n">frameInfo</span><span class="p">);</span>
      <span class="n">pointLightMirrored</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">frameInfo</span><span class="p">);</span>
      <span class="n">Renderer</span><span class="p">.</span><span class="n">endOffScreenRenderPass</span><span class="p">(</span><span class="n">commandBuffer</span><span class="p">);</span>

      <span class="c1">// Begin rendering to the swap chain.</span>
      <span class="n">Renderer</span><span class="p">.</span><span class="n">beginSwapChainRenderPass</span><span class="p">(</span><span class="n">commandBuffer</span><span class="p">);</span>

      <span class="c1">// Render game objects and lights. order here matters</span>
      <span class="n">objSystem</span><span class="p">.</span><span class="n">renderGameObjects</span><span class="p">(</span><span class="n">frameInfo</span><span class="p">);</span>
      <span class="n">pointLightSystem</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">frameInfo</span><span class="p">);</span>      

      <span class="c1">// Render mirrored objects and mirror planes.</span>
      <span class="n">mirrorSystem</span><span class="p">.</span><span class="n">renderMirrorPlane</span><span class="p">(</span><span class="n">frameInfo</span><span class="p">);</span>
      
      <span class="c1">// End rendering to the swap chain and end the fram and present it to the screen.</span>
      <span class="n">Renderer</span><span class="p">.</span><span class="n">endSwapChainRenderPass</span><span class="p">(</span><span class="n">commandBuffer</span><span class="p">);</span>
      <span class="n">Renderer</span><span class="p">.</span><span class="n">endFrame</span><span class="p">();</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Use the global descriptor set layout in our app during the pipeline creation stage.</p>

<p><code class="language-plaintext highlighter-rouge">mirror_system.cpp</code></p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">MirrorSystem</span><span class="o">::</span><span class="n">createPipelineLayout</span><span class="p">(</span><span class="n">VkDescriptorSetLayout</span> <span class="n">offscreenSetLayout</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">VkPushConstantRange</span> <span class="n">pushConstantRange</span><span class="p">{};</span>
  <span class="n">pushConstantRange</span><span class="p">.</span><span class="n">stageFlags</span> <span class="o">=</span> <span class="n">VK_SHADER_STAGE_VERTEX_BIT</span> <span class="o">|</span> <span class="n">VK_SHADER_STAGE_FRAGMENT_BIT</span><span class="p">;</span>
  <span class="n">pushConstantRange</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">pushConstantRange</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MirrorPushConstants</span><span class="p">);</span>

  <span class="n">renderSystemLayout</span> <span class="o">=</span> 
      <span class="n">DescriptorSetLayout</span><span class="o">::</span><span class="n">Builder</span><span class="p">(</span><span class="n">Device</span><span class="p">)</span>
          <span class="p">.</span><span class="n">addBinding</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER</span><span class="p">,</span>
            <span class="n">VK_SHADER_STAGE_VERTEX_BIT</span> <span class="o">|</span> <span class="n">VK_SHADER_STAGE_FRAGMENT_BIT</span><span class="p">)</span>
          <span class="p">.</span><span class="n">addBinding</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER</span><span class="p">,</span> <span class="n">VK_SHADER_STAGE_FRAGMENT_BIT</span><span class="p">)</span>
          <span class="p">.</span><span class="n">build</span><span class="p">();</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">VkDescriptorSetLayout</span><span class="o">&gt;</span> <span class="n">descriptorSetLayouts</span><span class="p">{</span>
    <span class="n">offscreenSetLayout</span><span class="p">,</span>
    <span class="n">renderSystemLayout</span><span class="o">-&gt;</span><span class="n">getDescriptorSetLayout</span><span class="p">()};</span>

  <span class="n">VkPipelineLayoutCreateInfo</span> <span class="n">pipelineLayoutInfo</span><span class="p">{};</span>
  <span class="n">pipelineLayoutInfo</span><span class="p">.</span><span class="n">sType</span> <span class="o">=</span> <span class="n">VK_STRUCTURE_TYPE_PIPELINE_LAYOUT_CREATE_INFO</span><span class="p">;</span>
  <span class="n">pipelineLayoutInfo</span><span class="p">.</span><span class="n">setLayoutCount</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">descriptorSetLayouts</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">pipelineLayoutInfo</span><span class="p">.</span><span class="n">pSetLayouts</span> <span class="o">=</span> <span class="n">descriptorSetLayouts</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
  <span class="n">pipelineLayoutInfo</span><span class="p">.</span><span class="n">pushConstantRangeCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">pipelineLayoutInfo</span><span class="p">.</span><span class="n">pPushConstantRanges</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pushConstantRange</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">vkCreatePipelineLayout</span><span class="p">(</span><span class="n">Device</span><span class="p">.</span><span class="n">device</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">pipelineLayoutInfo</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipelineLayout</span><span class="p">)</span> <span class="o">!=</span>
      <span class="n">VK_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">"failed to create pipeline layout!"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">MirrorSystem</span><span class="o">::</span><span class="n">createPipeline</span><span class="p">(</span><span class="n">VkRenderPass</span> <span class="n">renderPass</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">pipelineLayout</span> <span class="o">!=</span> <span class="nb">nullptr</span> <span class="o">&amp;&amp;</span> <span class="s">"Cannot create pipeline before pipeline layout"</span><span class="p">);</span>

  <span class="n">PipelineConfigInfo</span> <span class="n">pipelineConfig</span><span class="p">{};</span>
  <span class="n">Pipeline</span><span class="o">::</span><span class="n">defaultPipelineConfigInfo</span><span class="p">(</span><span class="n">pipelineConfig</span><span class="p">);</span>

  <span class="n">pipelineConfig</span><span class="p">.</span><span class="n">renderPass</span> <span class="o">=</span> <span class="n">renderPass</span><span class="p">;</span>
  <span class="n">pipelineConfig</span><span class="p">.</span><span class="n">pipelineLayout</span> <span class="o">=</span> <span class="n">pipelineLayout</span><span class="p">;</span>
  <span class="n">Pipeline</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Pipeline</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="n">Device</span><span class="p">,</span>
      <span class="s">"shaders/mirror.vert.spv"</span><span class="p">,</span>
      <span class="s">"shaders/mirror.frag.spv"</span><span class="p">,</span>
      <span class="n">pipelineConfig</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Shaders:
<a href="https://gist.github.com/bynmz/4b52af0f38d3adb532433aded186b32e" target="_blank">mirror.vert</a> /
<a href="https://gist.github.com/bynmz/60ed8c7408216b4c885a43c59da13dde" target="_blank">mirror.frag</a></p>

<p>With this all in place we are now able to render reflections in our app with Vulkan üéâ.</p>

<p><img src="/images/reflections.png" alt="" /></p>

<table>
<tr>
 
<td style="border: 0; text-align: left;">
<a class="prev" href="/2024/02/05/simple-ui-with-dear-imgui/">&laquo;&nbsp;Simple UI with Dear Imgui</a>
</td>
 
 
</tr>
</table>
<div id="disqus_thread" style="text-align: center">
	<a href="#" onclick="disqus(); return false;">Show Comments</a>
</div>

<script type="text/javascript">
    var disqus_shortname = 'bynmz';
    var disqus_url = "http://localhost:4000/2024/03/28/offscreen-rendering-in-vulkan/";
	var disqus_loaded = false;

	function disqus() {
		if (disqus_loaded) return;
		disqus_loaded = true;

		/* * * DON'T EDIT BELOW THIS LINE * * */
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}
</script>

	</div>
	
</body>
</html>
